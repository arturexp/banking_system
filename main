from random import randint
import sqlite3

with sqlite3.connect('card.s3db') as conn:
    cur = conn.cursor()

    cur.execute('''CREATE TABLE IF NOT EXISTS card (
                id INTEGER,
                number TEXT,
                pin TEXT,
                balance INTEGER DEFAULT 0
                );''')
    conn.commit()

users = {}
balance = 0


def main_menu():
    print('1. Create an account\n2. Log into account\n0. Exit')
    main_menu_choice = int(input())
    return main_menu_choice


def log_in():
    global balance
    print('Enter your card number:')
    user_login = input()
    print('Enter your PIN:')
    user_pin = input()
    with sqlite3.connect('card.s3db') as conn:
        cur = conn.cursor()
        cur.execute(f'SELECT number, pin, balance FROM card WHERE number = {user_login}')
        result = cur.fetchone()
        print(result)
    if len(user_login) != 16 or len(user_pin) != 4 or result is None or user_pin != result[1]:
        print('Wrong card number or PIN!\n')
        return False
    else:
        balance = result[2]
        return True


def create_card():
    global users
    iin = '400000'
    acc_id = str(randint(100000000, 999999999))
    number = iin + acc_id
    checksum = list(number)
    len_ = len(checksum)
    for x in range(len_):
        checksum[x] = int(checksum[x])
    for i in range(0, len_, 2):
        checksum[i] = checksum[i] * 2
        if int(checksum[i]) > 9:
            checksum[i] = checksum[i] - 9
    checksum = sum(checksum)
    checksum = (10 - checksum) % 10
    card_number = iin + acc_id + str(checksum)

    card_pin = str(randint(1000, 9999))
    with sqlite3.connect('card.s3db') as conn:
        cur = conn.cursor()

        cur.execute(f"INSERT INTO card ('number', 'pin') VALUES ({card_number}, {card_pin});")
        conn.commit()

    users.update({card_number: [card_pin, 0]})
    print('Your card has been created')
    print(f'Your card number:\n{card_number}')
    print(f'Your card PIN:\n{card_pin}\n')


def check_balance():
    print(f'Balance: {balance}\n')


def account_menu():
    print('You have successfully logged in!\n')
    while True:
        print('1. Balance\n2. Log out\n0. Exit')

        account_menu_choice = int(input())

        if account_menu_choice == 1:
            check_balance()
        elif account_menu_choice == 2:
            break
        elif account_menu_choice == 0:
            print('Bye!')
            quit()
        break


def main():
    while True:
        main_menu_choice = main_menu()
        if main_menu_choice == 1:
            create_card()
        elif main_menu_choice == 2:
            if log_in():
                account_menu()
            else:
                continue
        elif main_menu_choice == 0:
            print('Bye!')
            quit()


main()
